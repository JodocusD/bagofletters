{
    "collab_server" : "",
    "contents" : "# Plotting section data for Cameroonweb\n\n#import section data\n# dbConnect() call\nlibrary(RMySQL)\ncon <- dbConnect(RMySQL::MySQL(), \n                 dbname = 'rijk9_imkserver', \n                 host = \"qs3990.pair.com\", \n                 port = 0000,\n                 user = \"rijk9_12\",\n                 password = \"efiYjhFV\")\n#inspect tables\n#dbListTables(con)\n\nlibrary(DBI)\ncutofdate = c('2016-12-31') #not in use\npublisher <- 3  #imk publisher number; 3 = cameroonweb\nstartdate <- c('2016-12-31') #insert date before startdate\nenddate <- as.character(Sys.Date()) #insert date AFTER last day of reporting\n\nmyquery <- paste(\"SELECT  `date`, `ad_slot_id`, `channel_id`, `count` FROM `statistics_slots` WHERE `ad_slot_id` IN( '2',  '13',  '22',  '33', '381', '377', '380', '378', '379',  '42',  '52',  '66',  '63',  '61', '317', '144', '234', '240', '242', '246', '244', '248', '250', '216', '313', '318', '230', '210') AND `date` > '\", startdate, \"' AND `date` < '\", enddate, \"' AND `publisher_id` = \", publisher , sep ='')\ncmrallday <- dbGetQuery(con, myquery)\ncmrallday$date <- as.Date(cmrallday$date)\ncmrallday$ad_slot_id <- as.numeric(cmrallday$ad_slot_id)\n\n#disconnect DB\ndbDisconnect(con)\n\n#work with AdSlotKey file for labeling sections\nlibrary(readr)\nread_csv(\"AdSlotKey.csv\") -> slotkey\nslotkey$channel_id <- NULL\nslotkey$ad_slot_id <- as.numeric(slotkey$ad_slot_id)\nsectionlist <- c('HomePage', 'News', 'Entertainment', 'Sports', 'World', 'Business', 'Opinions', 'Members', 'Country', 'Jobs', 'Real Estate', 'Telephone Directory', 'Used Cars', 'Trucks')\nslotkey$section <- factor(slotkey$section, levels = sectionlist) \n\n#label data with sectionkey and organise\nlibrary(dplyr)\nsectjoin <- left_join(cmrallday, slotkey, by = ('ad_slot_id'))\nsectjoin$medium <- ifelse(sectjoin$channel_id == 1, 'Desktop', 'Mobile')\nsectjoin$count <- as.numeric(sectjoin$count)\n\n#Make a table of yesterdays data\ncmrdesksect <- sectjoin %>% \n  filter(medium == 'Desktop', date == as.Date(Sys.Date() -1)) %>% \n  select(c(1,4,5)) %>% rename(desktop = count)\ncmrmobisect <- sectjoin %>% \n  filter(medium == 'Mobile', date == as.Date(Sys.Date() -1)) %>% \n  select(c(1,4,5)) %>% rename(mobile = count)\nyestertable <- full_join(cmrdesksect, cmrmobisect, by = c('date', 'section'))\nyestertable <- yestertable[c(1,3,2,4)] %>%  select(2:4)\nyestertabletotal <- summarise(yestertable, desktop = sum(desktop), mobile = sum(mobile, na.rm = TRUE))\n    row.names(yestertabletotal) <- c('Total')\n  \n##!!!remove outliers  (method just copied). Select 1 of 2 lines. Top = filter, bottom is NO FILTER\n#sectclean <- sectjoin %>% group_by(ad_slot_id) %>% filter(!(abs(count - median(count)) > 3*sd(count)))\nsectclean <- sectjoin\n\n\n#Top sections\nlibrary(data.table)\nsect1 <- as.data.table(filter(sectclean, section %in% c('HomePage', 'Sports', 'Entertainment', 'Business', 'World')))\n#sect1[(ad_slot_id == 317 & date < '2016-04-14'), count:=count/1.5] \nsect1$section <- factor(sect1$section, levels = c('HomePage', 'News', 'Entertainment', 'Sports', 'World', 'Business', 'Opinions', 'Members', 'Country', 'Jobs', 'Real Estate', 'Telephone Directory', 'Used Cars', 'Trucks')) \n\n#2nd Tier sections\nsect2 <- filter(sectclean, section %in% c('Opinions', 'Members', 'Country', 'Jobs', 'Real Estate', 'Telephone Directory')) \nsect2$section <- factor(sect2$section, levels = c('HomePage', 'News', 'Entertainment', 'Sports', 'World', 'Business', 'Opinions', 'Members', 'Country', 'Jobs', 'Real Estate', 'Telephone Directory', 'Used Cars', 'Trucks')) \n\n#Section Plots\n\n#testplots based on cmrallday\nlibrary(ggplot2)\nlibrary(RColorBrewer)\nlibrary(ggthemes)\ncols <- brewer.pal(8, 'Set1')\n\n#PLOT top and bottom sections\n\n# #Low Indiv. y-axis\n# ggplot(data = sectlowsect, aes(date, count, col = section)) +  \n#   geom_point(alpha = 1) + \n#   labs(title ='Daily PageViews for Low Volume Sections: Individual y-axis', y = 'pageviews')  +\n#   theme_light() +\n#   scale_color_manual(values = cols) +\n#   facet_grid(section ~ medium, scales = 'free_y') \n\n#High Indiv y-axis\n# ggplot(data = secttopsect, aes(date, count, col = section)) + \n#   geom_point(alpha = 1) + \n#   labs(title ='Daily PageViews for High Volume Sections: Individual y-axis', y = 'pageviews')  +\n#   theme_light() +\n#   scale_color_manual(values = cols) +\n#   facet_grid(section ~ medium, scales = 'free_y') \n\n#High Shared y-axis\nmaxyax_sect1 <- signif(max(sect1$count)*1.1, 2)\ncmrp2 <- ggplot(data = sect1, aes(date, count, col = section)) + \n  geom_point(alpha = .8, size = 2) + \n  labs(title = 'Daily PageViews part I', y = 'pageviews')  +\n  scale_y_continuous(breaks = seq(0, maxyax_sect1, by = maxyax_sect1/5), limits = c(0, maxyax_sect1), expand = c(0, 0)) +\n  theme_light() + guides(col=FALSE) + \n  scale_color_manual(values = cols) +\n  facet_grid(section ~ medium) \n\n#Middle Shared y-axis\nmaxyax_sect2 <- signif(max(sect2$count)*1.1, 2)\ncmrp3 <- ggplot(data = sect2, aes(date, count, col = section)) + \n  geom_point(alpha = .8, size = 2) + \n  labs(title = 'Daily PageViews part II', y = 'pageviews')  +\n  scale_y_continuous(breaks = seq(0, maxyax_sect2, by = maxyax_sect2/5), limits = c(0, maxyax_sect2), expand = c(0, 0)) +\n  theme_light() + guides(col=FALSE) + \n  scale_color_manual(values = cols) +\n  facet_grid(section ~ medium) \n\n\n##Plots for a single section\n##first fill in section of interest below\nsectionofinterest <- c('News')\n\nsinglesect <- as.data.table(filter(sectclean, section %in% sectionofinterest))\nsinglesect$section <- factor(singlesect$section, levels = sectionofinterest)\n\nmaxyax_singlsect <- signif(max(singlesect$count)*1.1, 2)\nticksyax_singlsect <- floor(round(max(singlesect$count)*1.1))\n\ncmrp1 <- ggplot(data = singlesect, aes(date, count, col = section)) +\n  geom_point(alpha = .8, size = 2) +\n  labs(title = paste('Daily PageViews for', sectionofinterest, sep = ' '), y = \"pageviews\") +\n  theme_light() +\n  theme(axis.text.x = element_text(angle = 90), legend.position=\"none\") +\n  scale_y_continuous(breaks = seq(0, maxyax_singlsect, by = maxyax_singlsect/5), limits = c(0, maxyax_singlsect), expand = c(0, 0)) +\n  scale_color_manual(values = cols) +\n  facet_grid(section ~ medium)\n\n\n\n",
    "created" : 1484572667977.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3722203269",
    "id" : "1530C457",
    "lastKnownWriteTime" : 1484656466,
    "last_content_update" : 1484656466515,
    "path" : "~/Desktop/R/Engagement/Sections Cameroon.R",
    "project_path" : "Sections Cameroon.R",
    "properties" : {
        "docOutlineVisible" : "0",
        "tempName" : "Untitled1"
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}